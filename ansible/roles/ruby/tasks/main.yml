- name: Check if Ruby is installed
  command: ruby -v
  register: ruby_check
  ignore_errors: yes

- name: Import GPG keys for rvm
  ansible.builtin.command: 
    cmd: gpg2 --keyserver keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
  when: ruby_check.failed
  register: gpg_import
  retries: 5
  delay: 10
  until: gpg_import.rc == 0
  changed_when: false

- name: Install rvm
  ansible.builtin.shell: 
    cmd: curl -sSL https://get.rvm.io | bash -s stable
  when: ruby_check.failed
  changed_when: false

- name: Source rvm script
  ansible.builtin.lineinfile:
    path: /home/ec2-user/.bashrc
    line: 'if [[ -s $HOME/.rvm/scripts/rvm ]] ; then source $HOME/.rvm/scripts/rvm ; fi'
    state: present
  when: ruby_check.failed
  changed_when: false

- name: load .bashrc
  ansible.builtin.shell:
    cmd: /bin/bash -lc "source /home/ec2-user/.bashrc"
  when: ruby_check.failed
  changed_when: false

- name: Install ruby
  ansible.builtin.shell:
    cmd: /bin/bash -lc "rvm install ruby-3.2.3"
  when: ruby_check.failed
  environment:
    PATH: "{{ansible_env.PATH}}:/home/ec2-user/.rvm/bin"
  register: ruby_install
  changed_when: false

- name: Set default ruby version
  ansible.builtin.shell:
    cmd: /bin/bash -lc "rvm use 3.2.3 --default"
  environment:
    PATH: "{{ansible_env.PATH}}:/home/ec2-user/.rvm/bin"
  when: ruby_install.changed

- name: Install Ruby 3.2.3
  shell: bash -lc "rbenv install 3.2.3"
  when: not ruby_check.stat.exists

- name: Rehash rbenv
  shell: bash -lc "rbenv rehash"

- name: Set global Ruby version to 3.2.3
  shell: bash -lc "rbenv global 3.2.3"


# Install Rails
- name: Check if Rails is installed
  shell: bash -lc "gem list -e rails | grep 7.1.3.2"
  register: rails_check
  changed_when: no
  ignore_errors: true

- name: Install Rails 7.1.3.2
  gem:
    name: rails
    version: 7.1.3.2
    user_install: no
    executable: /home/ec2-user/.rbenv/shims/gem
  when: rails_check is failed

- name: Check if Bundler is installed
  stat:
    path: /home/ec2-user/.rbenv/versions/3.2.3/bin/bundle
  register: bundler_check

- name: Install Bundler
  command: bash -lc "gem install bundler"