- name: Check if bundler is installed
  shell: bash -lc "bundler -v | grep {{ bundler_version }}"
  register: has_bundler_1
  changed_when: False
  ignore_errors: yes

- name: Update bundler
  shell: bash -lc "source ~/.bash_profile && gem install bundler -v {{ bundler_version }}"
  args:
    chdir: "{{ sample_app_dir }}"
  when: has_bundler_1.failed

- name: Check bundler installed
  shell: bash -lc "source ~/.bash_profile && bundle -v | grep {{ bundler_version }}"
  register: bundler_version_check
  changed_when: False

- name: Install gems
  shell: bash -lc "source ~/.bash_profile && bundle install"
  args:
    chdir: "{{ sample_app_dir }}"
  when: not was_cloned_rails.stat.exists or has_directory_gemfile.stat.exists

- name: Install webpacker
  shell: bash -lc "source ~/.bash_profile && bundle exec rails webpacker:install"
  args:
    chdir: "{{ sample_app_dir }}"
  when: not was_cloned_rails.stat.exists or has_directory_gemfile.stat.exists

- name: Check bundler install
  shell: /home/ec2-user/.rbenv/shims/bundler --version
  register: check_bundler_installed
  changed_when: no
  ignore_errors: yes

- name: Install bundler
  gem: 
    name: bundler
    version: "{{ bundler_version }}"
    executable: /home/ec2-user/.rbenv/shims/gem
    user_install: no
  when: check_bundler_installed is failed